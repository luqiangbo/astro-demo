pipeline:
  build-dev:
    image: docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker stop astro1 && docker rm astro1
      - docker run -d -p 9000:80 --name astro1 -e WEB_ENV=build:dev .
    when:
      event: tag
      branch: '*'
      ref: refs/tags/dev.*
    privileged: true
  build-prod:
    image: docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker-compose down
      - docker-compose build
      - docker-compose up -e WEB_ENV=build:prod -e ENV=prod -d
    when:
      event: tag
      branch: '*'
      ref: refs/tags/prod.*
    privileged: true
